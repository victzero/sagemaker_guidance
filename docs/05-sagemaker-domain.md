# 05 - SageMaker Domain è®¾è®¡

> æœ¬æ–‡æ¡£æè¿° SageMaker Domain çš„åˆ›å»ºå’Œé…ç½®

---

## å ä½ç¬¦è¯´æ˜

> ğŸ“Œ æœ¬æ–‡æ¡£ä½¿ç”¨ä»¥ä¸‹å ä½ç¬¦ï¼Œå®æ–½æ—¶è¯·æ›¿æ¢ä¸ºå®é™…å€¼ã€‚

| å ä½ç¬¦ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `vpc-xxxxxxxxx` | VPC IDï¼ˆå¾…ç¡®è®¤ï¼‰ | `vpc-0abc123def456` |
| `subnet-a`, `subnet-b` | å­ç½‘ IDï¼ˆå¾…ç¡®è®¤ï¼‰ | `subnet-0abc123def456` |
| `sg-sagemaker-studio` | å®‰å…¨ç»„åç§° | æŒ‰è§„èŒƒåˆ›å»º |
| `d-xxxxxxxxx` | Domain IDï¼ˆåˆ›å»ºåè·å–ï¼‰ | `d-abc123def456` |

---

## 1. Domain æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Domain

SageMaker Domain æ˜¯ SageMaker Studio çš„é€»è¾‘è¾¹ç•Œï¼ŒåŒ…å«ï¼š

- User Profilesï¼ˆç”¨æˆ·é…ç½®ï¼‰
- Shared Spacesï¼ˆå…±äº«ç©ºé—´ï¼‰
- Appsï¼ˆåº”ç”¨å®ä¾‹ï¼‰
- å®‰å…¨å’Œç½‘ç»œé…ç½®

### 1.2 Domain ç­–ç•¥

| æ–¹æ¡ˆ                | ä¼˜ç‚¹               | ç¼ºç‚¹                     | é€‰æ‹© |
| ------------------- | ------------------ | ------------------------ | ---- |
| **å•ä¸€ Domain**     | ç®¡ç†ç®€å•ã€èµ„æºå…±äº« | éœ€è¦ç²¾ç»†æƒé™æ§åˆ¶         | âœ…   |
| å¤š Domainï¼ˆæ¯å›¢é˜Ÿï¼‰ | éš”ç¦»å½»åº•           | ç®¡ç†å¤æ‚ã€æ— æ³•è·¨å›¢é˜Ÿåä½œ | âŒ   |

**æœ¬é¡¹ç›®é€‰æ‹©**ï¼šå•ä¸€ Domainï¼Œé€šè¿‡ User Profile + Space + IAM å®ç°éš”ç¦»

---

## 2. Domain é…ç½®

### 2.1 åŸºç¡€é…ç½®

| é…ç½®é¡¹                 | å€¼                         | è¯´æ˜            |
| ---------------------- | -------------------------- | --------------- |
| Domain Name            | ml-platform-domain         | å¹³å°ç»Ÿä¸€ Domain |
| Auth Mode              | **IAM**                    | ä½¿ç”¨ IAM Users  |
| App Network Access     | **VPCOnly**                | ä»… VPC å†…è®¿é—®   |
| Default Execution Role | æ— ï¼ˆç”± User Profile æŒ‡å®šï¼‰ | -               |

### 2.2 VPC é…ç½®

| é…ç½®é¡¹          | å€¼                  | è¯´æ˜            |
| --------------- | ------------------- | --------------- |
| VPC             | vpc-xxxxxxxxx       | ç°æœ‰ VPC        |
| Subnets         | subnet-a, subnet-b  | Private Subnets |
| Security Groups | sg-sagemaker-studio | Studio å®‰å…¨ç»„   |

### 2.3 å­˜å‚¨é…ç½®

| é…ç½®é¡¹           | å€¼       | è¯´æ˜                       |
| ---------------- | -------- | -------------------------- |
| Default EBS Size | 100 GB   | é»˜è®¤å­˜å‚¨ç©ºé—´ï¼ˆå¯æŒ‰éœ€ä¸Šè°ƒï¼‰ |
| EFS              | è‡ªåŠ¨åˆ›å»º | ç”¨äº Studio Home           |

> è¯´æ˜ï¼šEBS é»˜è®¤å€¼å»ºè®®ä»¥â€œå‡å°‘é¢‘ç¹æ‰©å®¹ + æ§åˆ¶æˆæœ¬â€ä¸ºå¹³è¡¡ç‚¹ã€‚å®é™…å¯é…ç½®æ›´å¤§å®¹é‡ï¼Œé€šå¸¸å—æœåŠ¡é…é¢/åŒºåŸŸé™åˆ¶å½±å“ï¼Œè½åœ°å‰åº”åœ¨ç›®æ ‡è´¦å·/åŒºåŸŸå®Œæˆä¸€æ¬¡é…ç½®éªŒè¯ã€‚

---

## 3. Domain ç½‘ç»œæ¨¡å¼è¯¦è§£

### 3.1 VPCOnly æ¨¡å¼

```
ç”¨æˆ·æµè§ˆå™¨
    â”‚
    â”‚ HTTPS
    â–¼
AWS Console
    â”‚
    â”‚ CreatePresignedDomainUrl API
    â–¼
Presigned URL
    â”‚
    â”‚ é‡å®šå‘
    â–¼
SageMaker Studio (VPC å†…)
    â”‚
    â”‚ ENI in Private Subnet
    â–¼
VPC Endpoints â†’ AWS Services
```

### 3.2 ç½‘ç»œæµé‡è·¯å¾„

| æµé‡ç±»å‹  | è·¯å¾„                            | è¯´æ˜          |
| --------- | ------------------------------- | ------------- |
| Studio UI | Console â†’ Presigned URL â†’ VPC   | é€šè¿‡ AWS å†…éƒ¨ |
| S3 æ•°æ®   | Studio â†’ S3 VPC Endpoint â†’ S3   | VPC å†…éƒ¨      |
| API è°ƒç”¨  | Studio â†’ SageMaker VPC Endpoint | VPC å†…éƒ¨      |

---

## 4. Default Settingsï¼ˆé»˜è®¤è®¾ç½®ï¼‰

### 4.1 JupyterLab é»˜è®¤è®¾ç½®

| é…ç½®é¡¹             | æ¨èå€¼       | è¯´æ˜                         |
| ------------------ | ------------ | ---------------------------- |
| Default Instance   | ml.t3.medium | åŸºç¡€å¼€å‘                     |
| Auto Shutdown Idle | 60 åˆ†é’Ÿ      | æˆæœ¬æ§åˆ¶                     |
| Lifecycle Config   | **å¼ºçƒˆå»ºè®®** | å¯åŠ¨è„šæœ¬ï¼ˆå« idle-shutdownï¼‰ |

> ğŸ’¡ **æˆæœ¬ç®¡æ§**ï¼šå¼ºçƒˆå»ºè®®é…ç½® Lifecycle Configuration è„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹ Jupyter Kernel ç©ºé—²å¹¶å…³é—­å®ä¾‹ã€‚æœªé…ç½®æ­¤è„šæœ¬å¯èƒ½å¯¼è‡´ GPU å®ä¾‹ï¼ˆå¦‚ `ml.g4dn`ã€`ml.p3`ï¼‰æŒç»­è¿è¡Œäº§ç”Ÿè¾ƒé«˜è´¹ç”¨ã€‚

### 4.2 é»˜è®¤ Space è®¾ç½®

| é…ç½®é¡¹           | æ¨èå€¼       | è¯´æ˜                         |
| ---------------- | ------------ | ---------------------------- |
| Default Instance | ml.t3.medium | å…±äº«ç©ºé—´é»˜è®¤                 |
| EBS Size         | 100 GB       | é»˜è®¤å­˜å‚¨ï¼ˆå¯æŒ‰é¡¹ç›®ç”³è¯·ä¸Šè°ƒï¼‰ |

### 4.3 å®ä¾‹è§„æ ¼æ²»ç†ï¼ˆç™½åå•/ä¸Šé™ï¼‰

ä¸ºé™ä½æˆæœ¬é£é™©å¹¶æå‡å¯æ§æ€§ï¼Œå»ºè®®åœ¨â€œå¹³å°ç­–ç•¥å±‚â€é™åˆ¶ Studio å¯ç”¨å®ä¾‹è§„æ ¼ï¼š

- **ç™½åå•**ï¼šä»…å…è®¸æŒ‡å®šçš„ instance typesï¼ˆä¾‹å¦‚é™åˆ¶åœ¨å¸¸ç”¨å®¶æ—ä¸å›ºå®šæ¡£ä½ï¼‰ã€‚
- **ä¸Šé™**ï¼šå°†æœ€å¤§è§„æ ¼é™å®šåœ¨æŸä¸ªå°ºå¯¸ï¼ˆä¾‹å¦‚ä¸è¶…è¿‡ `*4xlarge`ï¼‰ï¼Œè¶…å‡ºéœ€è¦å¹³å°ç®¡ç†å‘˜ä¸´æ—¶æ”¾è¡Œæˆ–å®¡æ‰¹ã€‚
- **å¼ºåˆ¶æ‰‹æ®µ**ï¼šä»¥ IAM Policy å¯¹ `CreateApp/UpdateApp` è¿›è¡Œæ¡ä»¶çº¦æŸï¼ˆæ¯”â€œé»˜è®¤å€¼/æ¨èå€¼â€æ›´å…·å¼ºåˆ¶åŠ›ï¼‰ã€‚

> éªŒæ”¶è¦ç‚¹ï¼šæ™®é€šå¼€å‘è€…å°è¯•é€‰æ‹©è¶…å‡ºç™½åå•/ä¸Šé™çš„å®ä¾‹è§„æ ¼æ—¶ï¼Œåº”è§¦å‘ AccessDeniedï¼ˆæˆ–åœ¨ UI ä¾§ä¸å¯è§/ä¸å¯é€‰ï¼‰ï¼Œç¡®ä¿ç­–ç•¥å¯è¢«è¯æ˜åœ°æ‰§è¡Œã€‚

### 4.4 å®ä¾‹ç™½åå•ç­–ç•¥ï¼ˆå‚è€ƒï¼‰

> è¯´æ˜ï¼šä»¥ä¸‹ä¸ºâ€œå‚è€ƒç™½åå•â€ï¼Œç”¨äºç»™å¹³å°ç­–ç•¥æä¾›ä¸€ä¸ªèµ·ç‚¹ã€‚å®é™…åº”ç»“åˆåŒºåŸŸå¯ç”¨æ€§ã€é…é¢ä¸æˆæœ¬æ²»ç†è¦æ±‚è¿›è¡Œè°ƒæ•´ã€‚

| åˆ†å±‚     | æ¨èç”¨é€”                    | å‚è€ƒç™½åå•ï¼ˆç¤ºä¾‹ï¼‰                                             |
| -------- | --------------------------- | -------------------------------------------------------------- |
| åŸºç¡€å¼€å‘ | æ—¥å¸¸ Notebookã€è½»é‡æ•°æ®å¤„ç† | `ml.t3.medium`, `ml.t3.large`, `ml.t3.xlarge`, `ml.t3.2xlarge` |
| è®¡ç®—å¯†é›† | CPU å¯†é›†å‹ç‰¹å¾å·¥ç¨‹/æ‰¹å¤„ç†   | `ml.c5.xlarge`, `ml.c5.2xlarge`, `ml.c5.4xlarge`               |

å»ºè®®åŒæ—¶é…ç½®â€œ**æœ€å¤§å®ä¾‹ä¸Šé™**â€ï¼ˆä¾‹å¦‚æœ€å¤§ä¸è¶…è¿‡ `*4xlarge`ï¼‰ï¼Œå¹¶å¯¹ä¾‹å¤–ä½¿ç”¨èµ°å®¡æ‰¹/ä¸´æ—¶æ”¾è¡Œæµç¨‹ã€‚

---

## 5. Domain åˆ›å»ºå‚æ•°

### 5.1 æ ¸å¿ƒå‚æ•°

```
Domain é…ç½®:
- DomainName: ml-platform-domain
- AuthMode: IAM
- AppNetworkAccessType: VpcOnly
- VpcId: vpc-xxxxxxxxx
- SubnetIds: [subnet-a, subnet-b]
- DefaultUserSettings:
    - SecurityGroups: [sg-sagemaker-studio]
    - (ExecutionRole ç”± User Profile å•ç‹¬æŒ‡å®š)
```

### 5.2 æ ‡ç­¾

| Tag Key     | Tag Value          |
| ----------- | ------------------ |
| Name        | ml-platform-domain |
| Environment | production         |
| ManagedBy   | platform-team      |

---

## 6. Domain åˆ›å»ºåçš„èµ„æº

Domain åˆ›å»ºåä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹èµ„æºï¼š

| èµ„æºç±»å‹       | åç§°æ¨¡å¼ | è¯´æ˜           |
| -------------- | -------- | -------------- |
| EFS            | è‡ªåŠ¨åˆ›å»º | ç”¨æˆ· Home ç›®å½• |
| Security Group | è‡ªåŠ¨åˆ›å»º | EFS è®¿é—® SG    |
| ENI            | æŒ‰éœ€åˆ›å»º | æ¯ä¸ª App ä¸€ä¸ª  |

---

## 7. è®¤è¯æµç¨‹ï¼ˆIAM æ¨¡å¼ï¼‰

### 7.1 ç”¨æˆ·ç™»å½•æµç¨‹

```
1. IAM User ç™»å½• AWS Console
   â””â”€â”€ ä½¿ç”¨ç”¨æˆ·å/å¯†ç  + MFA

2. å¯¼èˆªåˆ° SageMaker â†’ Studio
   â””â”€â”€ Console è°ƒç”¨ ListUserProfiles

3. é€‰æ‹© User Profile
   â””â”€â”€ å¿…é¡»æ˜¯å±äºè¯¥ IAM User çš„ Profile

4. ç‚¹å‡» Open Studio
   â””â”€â”€ Console è°ƒç”¨ CreatePresignedDomainUrl

5. æµè§ˆå™¨é‡å®šå‘åˆ° Studio
   â””â”€â”€ Presigned URL æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿ

6. Studio åŠ è½½
   â””â”€â”€ ä½¿ç”¨ User Profile çš„ Execution Role
```

### 7.2 æƒé™è¦æ±‚

IAM User éœ€è¦ä»¥ä¸‹æƒé™æ‰èƒ½ç™»å½• Studioï¼š

```
å¿…éœ€æƒé™:
- sagemaker:DescribeDomain
- sagemaker:DescribeUserProfile
- sagemaker:CreatePresignedDomainUrl
- sagemaker:ListApps

æ¡ä»¶:
- User Profile å¿…é¡»å±äºè¯¥ IAM User
- User Profile éœ€è¦åŒ…å«æ­£ç¡®çš„ Tags æˆ–å‘½å
```

---

## 8. Domain ç®¡ç†

### 8.1 ç”Ÿå‘½å‘¨æœŸç®¡ç†

| æ“ä½œ        | è¯´æ˜         | å½±å“           |
| ----------- | ------------ | -------------- |
| åˆ›å»º Domain | åˆå§‹åŒ–å¹³å°   | ä¸€æ¬¡æ€§         |
| æ›´æ–° Domain | ä¿®æ”¹é»˜è®¤è®¾ç½® | ä¸å½±å“ç°æœ‰ App |
| åˆ é™¤ Domain | æ¸…ç†æ‰€æœ‰èµ„æº | **ç ´åæ€§æ“ä½œ** |

### 8.2 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡                 | è¯´æ˜         | å‘Šè­¦é˜ˆå€¼     |
| -------------------- | ------------ | ------------ |
| Active User Profiles | æ´»è·ƒç”¨æˆ·æ•°   | -            |
| Running Apps         | è¿è¡Œä¸­çš„ App | æ ¹æ®é¢„ç®—è®¾ç½® |
| EFS ä½¿ç”¨é‡           | å­˜å‚¨ä½¿ç”¨     | 80%          |

---

## 9. ä¸å…¶ä»–èµ„æºçš„å…³ç³»

### 9.1 ä¾èµ–å…³ç³»

```
Domain ä¾èµ–:
â”œâ”€â”€ VPC (å¿…é¡»å…ˆå­˜åœ¨)
â”œâ”€â”€ Subnets (å¿…é¡»å…ˆå­˜åœ¨)
â”œâ”€â”€ Security Groups (å¿…é¡»å…ˆå­˜åœ¨)
â””â”€â”€ VPC Endpoints (å¿…é¡»å…ˆå­˜åœ¨)

Domain è¢«ä¾èµ–:
â”œâ”€â”€ User Profiles (Domain åˆ›å»ºå)
â”œâ”€â”€ Spaces (Domain åˆ›å»ºå)
â””â”€â”€ Apps (Domain åˆ›å»ºå)
```

### 9.2 åˆ›å»ºé¡ºåº

```
1. VPC ç›¸å…³ (å·²å­˜åœ¨)
   â”œâ”€â”€ VPC
   â”œâ”€â”€ Subnets
   â”œâ”€â”€ Route Tables
   â””â”€â”€ Internet/NAT Gateway

2. å®‰å…¨ç›¸å…³
   â”œâ”€â”€ Security Groups
   â””â”€â”€ VPC Endpoints

3. IAM ç›¸å…³
   â”œâ”€â”€ IAM Policies
   â”œâ”€â”€ IAM Roles (Execution Roles)
   â”œâ”€â”€ IAM Groups
   â””â”€â”€ IAM Users

4. S3 ç›¸å…³
   â””â”€â”€ S3 Buckets

5. SageMaker
   â”œâ”€â”€ Domain (æœ¬æ–‡æ¡£)
   â”œâ”€â”€ User Profiles (ä¸‹ä¸€æ–‡æ¡£)
   â””â”€â”€ Spaces (å†ä¸‹ä¸€æ–‡æ¡£)
```

---

## 10. å¾…å®Œå–„å†…å®¹

- [ ] å®Œæ•´çš„ CLI/CloudFormation åˆ›å»ºå‘½ä»¤
- [ ] Lifecycle Configuration è„šæœ¬
- [ ] EFS åŠ å¯†é…ç½®
- [ ] è‡ªå®šä¹‰é•œåƒé…ç½®

---

## 11. æ£€æŸ¥æ¸…å•

### åˆ›å»ºå‰

- [ ] ç¡®è®¤ VPC å’Œ Subnet ä¿¡æ¯
- [ ] åˆ›å»º Security Group
- [ ] åˆ›å»º VPC Endpoints
- [ ] ç¡®è®¤ IAM Roles å·²åˆ›å»º

### åˆ›å»ºæ—¶

- [ ] ä½¿ç”¨ IAM è®¤è¯æ¨¡å¼
- [ ] é€‰æ‹© VPCOnly ç½‘ç»œæ¨¡å¼
- [ ] é…ç½®æ­£ç¡®çš„ Subnets
- [ ] é…ç½®æ­£ç¡®çš„ Security Groups

### åˆ›å»ºå

- [ ] éªŒè¯ Domain çŠ¶æ€ä¸º InService
- [ ] éªŒè¯ EFS åˆ›å»ºæˆåŠŸ
- [ ] è®°å½• Domain ID
- [ ] å¼€å§‹åˆ›å»º User Profiles
